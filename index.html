<!DOCTYPE html>
<html>
<head>
    <link href="css/beautiful.css" rel="stylesheet" type="text/css" />
    <script src="prettify.js"></script>
</head>
<body>
    <div class="top">
        <h1>
            BodyBoom
        </h1>
        <div class="menun_top">
            <a href="index.html">Документация</a>
            <a href="todo.html">Заметки</a>
            <a href="diagram.html">Блок схема</a>
            <a href="deprecated.html">Не рекомендуется</a>
            <a href="api.html">API</a>
            <a href="examples.html">Примеры</a>
        </div>
    </div>
<div class="content_doc">
<div class="text">

<h2>Документация</h2>
<p>В этой документации содержится информация API расписания, 
    примеры использования, заметки в коде (TODO), блок схема объектов 
    и некоторое пояснение как все работает для сайта BodyBoom.ru</p>

<h3>Как все работает</h3>
<p>Есть компания BodyBoom. У нее есть множество спортивных клубов. 
    Нужно было разработать сайт с которого можно было бы записаться на 
    требуюмую тренировку в нужный день и время. Также записаться можно 
    только по определенным ограничениям. Например на тренировку 
    Аквааэробика AquaFit можно записаться только в пятницу.</p>
<p>Компания ведет учет всех тренеровок в программе 1С. 
    Также есть сервер который может выдавать расписания в виде JSON.</p>
<p>При запросе к БД 1С получаем JSON с различными тренировками.
    Этот JSON распарсиваем в внутренне представления расписания.
    Потом запрашиваем из локальной БД ограничения которые применяем к нашим данным.
    Ограничения определяют на какие тренировки запись возможна, а на какие нет.
    Какие-то тренировки или даже тренировочные залы вообще не выведутся в расписании.
    Те тренировки которые по ограничениям прошли и доступны для записи помечаются карандашем.
    Количество свободных мест не выводятся в расписании, потому как они все равно не корректны.
    Да и смысл высчитывать их серверу 1С, если доступны, по ограничениям, лишь некоторые из них.</p>
<p>Сервер 1С не присылает описание тренеровок, поэтому после 
    распирсивания JSON еще происходит обновление данных из локальной БД. 
    Добавляются описания к тренировкам, но как видно не ко всем. 
    Замечу что для каждой тренировки делается отдельный запрос к БД, что не есть хорошо. </p>
<p>Далее расписание выводится на странице. Если кликнуть по тренировке с карандашем,
    то происходит запрос c помощью сниппета "ajax". Этот снипппет тоже делает запрос к БД 1С
    за данными о тренировке и возвращает количество свободных мест.
    Если их больше 0, то можно записатся - откроется форма для записи, если нет то будет сообщение что нет мест.
</p>
<h3>Тренировки на которые разрешена запись на сайте</h3>
<p>Запись в день тренировки, запись заканчивается за 30 мин до начала тренировки, 
    только после 8 утра включительно, для следующих тренировок:</p>
<table class="table">
    <tr class="color_header">
        <td>ID</td>
        <td>Название тренировки</td>
    </tr>
    <tr>
        <td>1b4ce5db-d43b-11e4-84fe-001e6717c644</td>
        <td>?</td>
    </tr>
    <tr>
        <td>6055955a-48db-11e1-9f1f-001e6717c644</td>
        <td>Cycle</td>
    </tr>
    <tr>
        <td>6055955e-48db-11e1-9f1f-001e6717c644</td>
        <td>Be balanced</td>
    </tr>
    <tr>
        <td>98c1d199-3a63-11e4-84fe-001e6717c644</td>
        <td>Kangoo Jumps</td>
    </tr>
    <tr>
        <td>60559533-48db-11e1-9f1f-001e6717c644</td>
        <td>Yoga</td>
    </tr>
    <tr>
        <td>73415236-3a6a-11e4-84fe-001e6717c644</td>
        <td>TRX</td>
    </tr>
    <tr>
        <td>276c0db0-3cae-11e4-84fe-001e6717c644</td>
        <td>VipR</td>
    </tr>
    <tr>
        <td>9358bf40-00a2-11e2-9d03-001e6717c644</td>
        <td>FS</td>
    </tr>
    <tr>
        <td>4ec3e6f8-3a67-11e4-84fe-001e6717c644</td>
        <td>Orbit</td>
    </tr>
</table>
<p>Запись по пятницам на следующую неделю, только после 12 часов включительно, для следующих тренировок:</p>
<table class="table">
    <tr class="color_header">
        <td>ID</td>
        <td>Название тренировки</td>
    </tr>
    <tr>
        <td>60559560-48db-11e1-9f1f-001e6717c644</td>
        <td>Аквааэробика AquaFit</td>
    </tr>
    <tr>
        <td>d4952402-4b04-11e1-9f1f-001e6717c644</td>
        <td>Аквааэробика AquaFit (для беременных)</td>
    </tr>
</table>
<p>Запись каждое 25 число на весь месяц вперёд, клуб Чакалова (TODO:Не нашел такое правило в БД, возможно оно не работает), для следующих тренировок:</p>
<table class="table">
    <tr >
        <td>ID</td>
        <td>Название тренировки</td>
    </tr>
    <tr>
        <td>d4952432-4b04-11e1-9f1f-001e6717c644</td>
        <td>Baby - swim (н.у)</td>
    </tr>
    <tr>
        <td>d4952433-4b04-11e1-9f1f-001e6717c644</td>
        <td>Baby - swim (п.у)</td>
    </tr>
    <tr>
        <td>d4952434-4b04-11e1-9f1f-001e6717c644</td>
        <td>Swim training</td>
    </tr>
</table>
<br>
<h3>Тренировки которые нужно исключить из расписания</h3>
<br>
<table class="table">
    <tr class="color_header">
        <td>ID</td>
        <td>Название</td>
    </tr>
    <tr>
        <td>d685ae7f-f994-11e2-ab96-001e6717c644</td>
        <td>Персональное занятие групповые программы</td>
    </tr>
    <tr>
        <td>d685ae84-f994-11e2-ab96-001e6717c644</td>
        <td>Персональное занятие групповые программы</td>
    </tr>
    <tr>
        <td>d685ae80-f994-11e2-ab96-001e6717c644</td>
        <td>Персональное занятие групповые программы</td>
    </tr>
    <tr>
        <td>3fe9c739-1921-11e4-8033-001e6717c644</td>
        <td>Персональное занятие тренажерный зал</td>
    </tr>
    <tr>
        <td>a2e8710d-dd22-11e1-827b-001e6717c644</td>
        <td>Персональное занятие тренажерный зал</td>
    </tr>
    <tr>
        <td>d5f7aa35-853b-11e1-a122-001e6717c644</td>
        <td>Персональное занятие тренажерный зал</td>
    </tr>
    <tr>
        <td>26e83a79-dd1c-11e4-84fe-001e6717c644</td>
        <td>Персональное занятие</td>
    </tr>
</table>
<br>
<h3>Помещения которые исключаем из общего вывода, стартовые тренировки выводим отдельно</h3>
<br>
<table class="table">
    <tr class="color_header">
        <td>ID</td>
        <td>Название тренировки</td>
        <td>Адрес</td>
    </tr>
    <tr>
        <td>0e22150e-47f3-11e1-9f1f-001e6717c644</td>
        <td>Кардио-силовой тренажерные залы</td>
        <td>Качалова, 10</td>
    </tr>
    <tr>
        <td>a4ccb400-8391-11e1-a122-001e6717c644</td>
        <td>Кардио-силовой тренажерный зал</td>
        <td>Стахановская, 43</td>
    </tr>
    <tr>
        <td>a4ccb404-8391-11e1-a122-001e6717c644</td>
        <td>Кардио-силовой тренажерный зал</td>
        <td>1-я Красноармейская, 3</td>
    </tr>
    <tr>
        <td>a4ccb40b-8391-11e1-a122-001e6717c644</td>
        <td>Кардио-силовой тренажерный зал</td>
        <td>Хабаровская, 56</td>
    </tr>
    <tr>
        <td>f0cff268-0fca-11e3-afae-001e6717c644</td>
        <td>Кардио-силовой тренажерный зал</td>
        <td>Запорожская, 1а</td>
    </tr>
    <tr>
        <td>136085d4-404d-11e3-b21c-001e6717c644</td>
        <td>Тренажёрный зал</td>
        <td>Лодыгина 9</td>
    </tr>
    <tr>
        <td>a4ccb408-8391-11e1-a122-001e6717c644</td>
        <td>Стартовые тренировки</td>
        <td></td>
    </tr>
    <tr>
        <td>d1c1252c-2119-11e3-afae-001e6717c644</td>
        <td>Стартовые тренировки</td>
        <td></td>
    </tr>
    <tr>
        <td>38666533-46cf-11e3-bccf-001e6717c644</td>
        <td>Стартовые тренировки</td>
        <td></td>
    </tr>
    <tr>
        <td>4c24cdf3-46cf-11e3-bccf-001e6717c644</td>
        <td>Стартовые тренировки</td>
        <td></td>
    </tr>
    <tr>
        <td>5471163b-46cf-11e3-bccf-001e6717c644</td>
        <td>Стартовые тренировки</td>
        <td></td>
    </tr>
</table>
<br>
<h3>По какой формуле вычесляются количество мест доступных для записи</h3>
<p>Данные о свободных местах для записи на сайте приходят не корректные. Поэтому количество свободных мест вычесляется следующим кодом:</p>
<pre>   
public function getFree()
{
    if ($this->reserv > ($this->booking - $this->bookings)) {
        $free = $this->capacity - $this->reserv - $this->bookings;
    } else {
        $free = $this->capacity - $this->booking;
    }
    return $free;
}
</pre>
<p>Где bookings - количество записанных мест в клубе</p>
<p>booking - количество мест выделенных под запись в клубе</p>
<p>reserv - количество мест выделенное под запись на сайте</p>
<p>capacity - общее количество мест в зале клуба</p>
<p>Вообщем-то все это не важно, потому как при клике на тренеровку происходит запрос к БД 1С, которая возвращает количество свободных мест.</p>
<h3>Чанки</h3>
<p>1. schedule.rest.training. Шабон для одной тренировки. Используется для вывода расписания объектом DataGetter.</p>
<xmp>
<div class='details_of_training'>
    <a href='#enroll_modal' class='schedule_training [[if? &is=`[+available+]:==:1` &then=`pencil` ]]' 
        data-id='[+id+]' 
        data-timestamp='[+timestamp+]' 
        data-available='[+available+]' 
        data-description='[+description+]'
        data-typeid='[+typeid+]'>
        [+type+]
        <br>
    </a>
    <span class='schedule_trainer'>
        [+coach+]		
    </span>	
</div>
</xmp>

<p>2. schedule.rest.training.starting. Шаблон для стартовой тренировки.</p>
<xmp>
<div class='details_of_training'>
	<a 
		href='#enroll_modal' 
		class='schedule_training pencil' 
		data-id='[+id+]' 
		data-timestamp='[+timestamp+]' 
		data-club='[+club+]' 
		data-available='1' 
		data-description='Стартовая тренировка и вводный инструктаж.'
	>
		Записаться
		<br>
	</a>
</div>
</xmp>
</div>
</div>
<div class="bottom">Низ</div>
</body>
</html>